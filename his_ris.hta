<!DOCTYPE html>
<html>
<head>
<meta http-equiv="x-ua-compatible" content="ie=11">
<title>Dimed HIS/RIS — Panel de Control</title>
<HTA:APPLICATION
  ID="HisRisApp"
  APPLICATIONNAME="Dimed HIS/RIS"
  CAPTION="yes"
  SHOWINTASKBAR="yes"
  SINGLEINSTANCE="yes"
  WINDOWSTATE="normal"
  MINIMIZEBUTTON="yes"
  MAXIMIZEBUTTON="yes"
  SCROLL="no"
  INNERBORDER="no"
  SELECTION="no"
  CONTEXTMENU="no"
/>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: Segoe UI, sans-serif;
    background: #f0f4f8;
    color: #1a202c;
    overflow: hidden;
  }
  #titlebar {
    background: linear-gradient(135deg, #1e3a5f 0%, #2b6cb0 100%);
    color: white;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
  }
  #titlebar .logorow { display:flex; align-items:center; gap:12px; }
  #titlebar .logo    { font-size:18px; font-weight:700; letter-spacing:.5px; }
  #titlebar .sub     { font-size:11px; opacity:.75; margin-top:2px; }
  #titlebar .badge   {
    background: rgba(255,255,255,.15);
    border: 1px solid rgba(255,255,255,.3);
    border-radius: 20px;
    padding: 4px 14px;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .dot { display:inline-block; width:8px; height:8px; border-radius:50%; background:#fc8181; }
  .dot.green { background:#68d391; }

  #main { display:flex; height:calc(100vh - 62px); }

  /* ── Sidebar ── */
  #sidebar {
    width: 220px;
    background: #1a202c;
    padding: 12px 8px;
    overflow-y: auto;
    flex-shrink: 0;
  }
  .nav-section {
    color: #718096;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    padding: 10px 10px 5px;
    margin-top: 6px;
  }
  .nav-btn {
    display: block;
    width: 100%;
    background: transparent;
    border: none;
    color: #cbd5e0;
    font-size: 13px;
    padding: 9px 12px;
    text-align: left;
    border-radius: 7px;
    cursor: pointer;
    margin-bottom: 2px;
  }
  .nav-btn:hover        { background:#2d3748; color:white; }
  .nav-btn.active       { background:#2b6cb0; color:white; }
  .nav-btn.danger:hover { background:#742a2a; color:#fc8181; }
  .nav-btn .icon        { margin-right:8px; }

  /* ── Content ── */
  #content { flex:1; display:flex; flex-direction:column; overflow:hidden; }

  #cards {
    display: flex;
    gap: 12px;
    padding: 14px 20px 12px;
    background: white;
    border-bottom: 1px solid #e2e8f0;
  }
  .card {
    flex:1; background:#f7fafc;
    border:1px solid #e2e8f0; border-radius:10px;
    padding:10px 14px;
  }
  .card .label { font-size:10px; color:#718096; font-weight:700; text-transform:uppercase; letter-spacing:.8px; }
  .card .value { font-size:20px; font-weight:700; margin-top:2px; }
  .card.blue .value   { color:#2b6cb0; }
  .card.green .value  { color:#276749; }
  .card.orange .value { color:#c05621; }
  .card.red .value    { color:#c53030; }

  #log-area { flex:1; display:flex; flex-direction:column; padding:0 20px 14px; overflow:hidden; }
  #log-header {
    display:flex; align-items:center;
    justify-content:space-between;
    padding: 10px 0 6px;
  }
  #log-header .title { font-weight:600; font-size:14px; color:#2d3748; }
  #btn-clear {
    background:none; border:1px solid #cbd5e0;
    border-radius:6px; padding:3px 10px;
    font-size:12px; cursor:pointer; color:#718096;
  }
  #btn-clear:hover { background:#edf2f7; }
  #log {
    flex:1; background:#1a202c; border-radius:10px;
    padding:14px 16px; overflow-y:auto;
    font-family:Consolas,monospace; font-size:12px;
    line-height:1.7; color:#e2e8f0;
  }
  .ok   { color:#68d391; }
  .err  { color:#fc8181; }
  .info { color:#63b3ed; }
  .warn { color:#f6e05e; }
  .cmd  { color:#9ae6b4; opacity:.7; }
  .sep  { color:#2d3748; border-bottom:1px solid #2d3748; padding-bottom:4px; margin-bottom:6px; }

  /* Modal */
  #overlay {
    display:none; position:fixed; top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,.5); z-index:100;
    align-items:center; justify-content:center;
  }
  #overlay.show { display:flex; }
  #modal {
    background:white; border-radius:12px;
    padding:26px; width:390px;
    box-shadow:0 20px 60px rgba(0,0,0,.3);
  }
  #modal h3 { font-size:16px; margin-bottom:10px; }
  #modal p  { font-size:13px; color:#4a5568; margin-bottom:18px; line-height:1.6; }
  .modal-btns { display:flex; gap:10px; justify-content:flex-end; }
  .btn-ok  { background:#c53030; color:white; border:none; border-radius:7px; padding:8px 18px; font-size:13px; cursor:pointer; }
  .btn-cancel { background:#edf2f7; border:none; border-radius:7px; padding:8px 18px; font-size:13px; cursor:pointer; }
  .btn-ok:hover     { background:#9b2c2c; }
  .btn-cancel:hover { background:#e2e8f0; }

  /* Status bar */
  #statusbar {
    background:#2d3748; color:#a0aec0;
    font-size:11px; padding:4px 20px;
    display:flex; justify-content:space-between;
  }
</style>
</head>
<body>

<div id="titlebar">
  <div class="logorow">
    <img src="frontend/public/logo.png" alt="Dimed" style="height:38px;width:auto;"
         onerror="this.style.display='none'">
    <div>
      <div class="logo">Dimed HIS/RIS</div>
      <div class="sub">Panel de Control</div>
    </div>
  </div>
  <div class="badge">
    <span class="dot" id="sdot"></span>
    <span id="stext">Verificando...</span>
  </div>
</div>

<div id="main">
  <div id="sidebar">
    <div class="nav-section">Servicios</div>
    <button class="nav-btn" id="btn-up">      <span class="icon">&#9654;</span> Iniciar sistema</button>
    <button class="nav-btn" id="btn-down">    <span class="icon">&#9646;&#9646;</span> Detener sistema</button>
    <button class="nav-btn" id="btn-restart"> <span class="icon">&#8635;</span> Reiniciar</button>
    <button class="nav-btn" id="btn-build">   <span class="icon">&#9881;</span> Reconstruir imágenes</button>
    <button class="nav-btn" id="btn-status">  <span class="icon">&#9723;</span> Ver estado</button>

    <div class="nav-section">Base de Datos</div>
    <button class="nav-btn" id="btn-migrate"> <span class="icon">&#8659;</span> Migraciones</button>
    <button class="nav-btn" id="btn-seed">    <span class="icon">&#9670;</span> Datos iniciales</button>
    <button class="nav-btn" id="btn-backup">  <span class="icon">&#128190;</span> Backup BD</button>

    <div class="nav-section">Primer Arranque</div>
    <button class="nav-btn" id="btn-setup">   <span class="icon">&#10003;</span> Configuración inicial</button>

    <div class="nav-section">Diagnóstico</div>
    <button class="nav-btn" id="btn-health">  <span class="icon">&#10084;</span> Health check</button>
    <button class="nav-btn" id="btn-logs">    <span class="icon">&#9998;</span> Logs API (50 líneas)</button>

    <div class="nav-section">Acceso Rápido</div>
    <button class="nav-btn" id="btn-web">     <span class="icon">&#127760;</span> Abrir sistema</button>
    <button class="nav-btn" id="btn-apidocs"> <span class="icon">&#128196;</span> API Docs</button>
    <button class="nav-btn" id="btn-orthanc"> <span class="icon">&#128248;</span> Orthanc PACS</button>

    <div class="nav-section">Peligro</div>
    <button class="nav-btn danger" id="btn-clean"><span class="icon">&#128465;</span> Limpiar sistema</button>
  </div>

  <div id="content">
    <div id="cards">
      <div class="card blue">  <div class="label">Sistema</div>  <div class="value">:8080</div></div>
      <div class="card green"> <div class="label">API</div>       <div class="value">:8000</div></div>
      <div class="card orange"><div class="label">Orthanc</div>  <div class="value">:8043</div></div>
      <div class="card red">   <div class="label">HL7 MLLP</div> <div class="value">:2575</div></div>
    </div>

    <div id="log-area">
      <div id="log-header">
        <span class="title">&#9654; Consola de salida</span>
        <button id="btn-clear">Limpiar</button>
      </div>
      <div id="log">
        <div class="sep">Dimed HIS/RIS — Panel listo.</div>
        <div class="info">Seleccione una opción del menú lateral.</div>
        <br>
        <div class="cmd">  Sistema  &#9658; http://localhost:8080</div>
        <div class="cmd">  API Docs &#9658; http://localhost:8000/docs</div>
        <div class="cmd">  Orthanc  &#9658; http://localhost:8043</div>
      </div>
    </div>
  </div>
</div>

<div id="statusbar">
  <span id="sbleft">Dimed HIS/RIS v1.0.0</span>
  <span id="sbtime"></span>
</div>

<!-- Modal limpiar -->
<div id="overlay">
  <div id="modal">
    <h3>&#9888; Acción destructiva</h3>
    <p>Esto eliminará <strong>todos los contenedores y volúmenes</strong>,
       incluyendo la base de datos.<br><br>
       Esta acción <strong>NO se puede deshacer</strong>.</p>
    <div class="modal-btns">
      <button class="btn-cancel" id="btn-modal-cancel">Cancelar</button>
      <button class="btn-ok"     id="btn-modal-ok">Confirmar borrado</button>
    </div>
  </div>
</div>

<script type="text/javascript">

// ── Resize & center ──────────────────────────────────────────────
window.resizeTo(960, 690);
window.moveTo((screen.width - 960) / 2, (screen.height - 690) / 2);

// ── Base directory from HTA path ─────────────────────────────────
var BASE_DIR = (function () {
  var p = window.location.pathname;    // e.g. /C:/HIS_RIS/his_ris.hta
  p = p.replace(/^\//, '');            // remove leading /
  p = p.replace(/\//g, '\\');          // forward → back slashes
  return p.substring(0, p.lastIndexOf('\\')); // strip filename
})();

// ── Shell helpers ─────────────────────────────────────────────────
var WShell = new ActiveXObject('WScript.Shell');
var FSO    = new ActiveXObject('Scripting.FileSystemObject');

function run(cmd, wait) {
  var full = 'cmd.exe /c cd /d "' + BASE_DIR + '" && ' + cmd;
  return WShell.Run(full, 0, wait !== false);
}

function capture(cmd) {
  var full = 'cmd.exe /c cd /d "' + BASE_DIR + '" && ' + cmd + ' 2>&1';
  try {
    var ex = WShell.Exec(full);
    var out = '';
    while (!ex.StdOut.AtEndOfStream) out += ex.StdOut.ReadLine() + '\n';
    return out;
  } catch(e) { return 'Error: ' + e.message; }
}

// ── Log helpers ───────────────────────────────────────────────────
var logDiv = document.getElementById('log');

function addLog(text, cls) {
  var lines = String(text).split('\n');
  for (var i = 0; i < lines.length; i++) {
    if (lines[i] === '') continue;
    var d = document.createElement('div');
    d.className = cls || 'cmd';
    d.innerHTML = lines[i]
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    logDiv.appendChild(d);
  }
  logDiv.scrollTop = logDiv.scrollHeight;
}

function logSep()         { addLog('─'.repeat(48), 'sep'); }
function logOk(t)         { addLog(t, 'ok');   }
function logErr(t)        { addLog(t, 'err');  }
function logInfo(t)       { addLog(t, 'info'); }
function logWarn(t)       { addLog(t, 'warn'); }
function logCmd(t)        { addLog('> ' + t, 'cmd'); }
function logOutput(text)  {
  var lines = String(text).split('\n');
  for (var i = 0; i < lines.length; i++) {
    var l = lines[i];
    if (!l.trim()) continue;
    var cls = 'cmd';
    if (/error/i.test(l))   cls = 'err';
    else if (/warn/i.test(l)) cls = 'warn';
    else if (/info/i.test(l)) cls = 'info';
    addLog('  ' + l, cls);
  }
}

// ── Status badge ──────────────────────────────────────────────────
function setStatus(text, ok) {
  document.getElementById('stext').innerText = text;
  document.getElementById('sdot').className  = ok ? 'dot green' : 'dot';
  document.getElementById('sbleft').innerText =
    'Dimed HIS/RIS v1.0.0 — ' + (ok ? 'Servicios activos' : 'Servicios inactivos');
}

// ── Commands ──────────────────────────────────────────────────────
function cmdUp() {
  logSep(); logInfo('Iniciando servicios...');
  logCmd('docker compose up -d');
  var r = run('docker compose up -d');
  if (r === 0) {
    logOk('Servicios iniciados correctamente.');
    logOk('  Sistema : http://localhost:8080');
    logOk('  API     : http://localhost:8000');
    logOk('  Orthanc : http://localhost:8043');
    setStatus('Ejecutando', true);
  } else {
    logErr('Error al iniciar servicios (código ' + r + ').');
    setStatus('Error', false);
  }
}

function cmdDown() {
  logSep(); logInfo('Deteniendo servicios...');
  logCmd('docker compose down');
  run('docker compose down');
  logOk('Servicios detenidos.');
  setStatus('Detenido', false);
}

function cmdRestart() {
  logSep(); logInfo('Reiniciando sistema...');
  run('docker compose down');
  run('docker compose up -d');
  logOk('Sistema reiniciado.');
  setStatus('Ejecutando', true);
}

function cmdBuild() {
  logSep(); logWarn('Reconstruyendo imágenes (puede tardar varios minutos)...');
  logCmd('docker compose build');
  run('docker compose build');
  logOk('Imágenes reconstruidas.');
}

function cmdStatus() {
  logSep(); logInfo('Estado de contenedores:');
  logCmd('docker compose ps');
  logOutput(capture('docker compose ps'));
}

function cmdMigrate() {
  logSep(); logInfo('Ejecutando migraciones Alembic...');
  logCmd('docker compose exec api alembic upgrade head');
  logOutput(capture('docker compose exec api alembic upgrade head'));
  logOk('Migraciones completadas.');
}

function cmdSeed() {
  logSep(); logInfo('Cargando datos iniciales...');
  logCmd('docker compose exec api python -m app.db.seed');
  logOutput(capture('docker compose exec api python -m app.db.seed'));
  logOk('Datos iniciales cargados.');
  logOk('  admin / Admin123!   receptionist / Recep123!');
  logOk('  tecnico / Tecnico123!   radiologo / Radiologo123!   medico / Medico123!');
}

function cmdBackup() {
  logSep(); logInfo('Realizando backup de PostgreSQL...');
  var d = new Date();
  var ts = d.getFullYear()
    + ('0'+(d.getMonth()+1)).slice(-2)
    + ('0'+d.getDate()).slice(-2) + '_'
    + ('0'+d.getHours()).slice(-2)
    + ('0'+d.getMinutes()).slice(-2);
  var archivo = 'backups\\backup_his_ris_' + ts + '.sql';
  if (!FSO.FolderExists(BASE_DIR + '\\backups'))
    FSO.CreateFolder(BASE_DIR + '\\backups');
  logCmd('pg_dump > ' + archivo);
  var r = run('docker compose exec -T postgres pg_dump -U his_ris_user his_ris > "' + archivo + '"');
  if (r === 0) logOk('Backup guardado en: ' + archivo);
  else         logErr('Error al realizar backup (código ' + r + ').');
}

function cmdHealth() {
  logSep(); logInfo('Verificando salud del sistema...');
  var out;

  logCmd('curl http://localhost:8000/health');
  out = capture('curl -s --connect-timeout 3 http://localhost:8000/health');
  addLog('  API: ' + (out.trim() ? out.trim() : 'sin respuesta'), out.trim() ? 'ok' : 'err');

  logCmd('Orthanc http://localhost:8043/system');
  out = capture('curl -s --connect-timeout 3 -u orthanc:orthanc http://localhost:8043/system');
  addLog('  Orthanc: ' + (out.indexOf('Version') >= 0 ? 'OK' : 'sin respuesta'),
         out.indexOf('Version') >= 0 ? 'ok' : 'err');

  logCmd('pg_isready');
  out = capture('docker compose exec postgres pg_isready -U his_ris_user -d his_ris');
  addLog('  PostgreSQL: ' + out.trim(), out.indexOf('accepting') >= 0 ? 'ok' : 'err');

  logCmd('redis-cli ping');
  out = capture('docker compose exec redis redis-cli ping');
  addLog('  Redis: ' + out.trim(), out.trim() === 'PONG' ? 'ok' : 'err');
}

function cmdLogs() {
  logSep(); logInfo('Últimas 50 líneas de logs API:');
  logCmd('docker compose logs --tail=50 api');
  logOutput(capture('docker compose logs --tail=50 api'));
}

function cmdSetup() {
  logSep(); logWarn('=== CONFIGURACIÓN INICIAL ===');
  logInfo('1/4  Generando claves JWT (RSA 2048)...');
  if (!FSO.FolderExists(BASE_DIR + '\\infrastructure\\keys'))
    FSO.CreateFolder(BASE_DIR + '\\infrastructure\\keys');
  run('docker run --rm -v "' + BASE_DIR + '\\infrastructure\\keys:/keys" alpine/openssl genrsa -out /keys/private_key.pem 2048');
  run('docker run --rm -v "' + BASE_DIR + '\\infrastructure\\keys:/keys" alpine/openssl rsa -in /keys/private_key.pem -pubout -out /keys/public_key.pem');
  logOk('   Claves generadas.');
  logInfo('2/4  Iniciando servicios...');
  run('docker compose up -d --build');
  logOk('   Servicios iniciados.');
  logInfo('3/4  Ejecutando migraciones...');
  run('docker compose exec api alembic upgrade head');
  logOk('   Migraciones OK.');
  logInfo('4/4  Cargando datos iniciales...');
  run('docker compose exec api python -m app.db.seed');
  logOk('   Seed OK.');
  logSep();
  logOk('INSTALACIÓN COMPLETADA.');
  logOk('  Sistema : http://localhost:8080   /   admin / Admin123!');
  setStatus('Ejecutando', true);
}

function cmdClean() {
  hideModal();
  logSep(); logWarn('!!! LIMPIANDO SISTEMA — borrando contenedores y volúmenes !!!');
  logCmd('docker compose down -v --remove-orphans');
  run('docker compose down -v --remove-orphans');
  logOk('Sistema limpiado. Ejecute "Configuración inicial" para reinstalar.');
  setStatus('Detenido', false);
}

function clearLog() {
  logDiv.innerHTML =
    '<div class="sep">Consola limpiada.</div>';
}

function openUrl(url) {
  WShell.Run('explorer "' + url + '"', 1, false);
}

function showModal() { document.getElementById('overlay').className = 'show'; }
function hideModal() { document.getElementById('overlay').className = '';     }

// ── Wire up buttons ───────────────────────────────────────────────
document.getElementById('btn-up')          .onclick = cmdUp;
document.getElementById('btn-down')        .onclick = cmdDown;
document.getElementById('btn-restart')     .onclick = cmdRestart;
document.getElementById('btn-build')       .onclick = cmdBuild;
document.getElementById('btn-status')      .onclick = cmdStatus;
document.getElementById('btn-migrate')     .onclick = cmdMigrate;
document.getElementById('btn-seed')        .onclick = cmdSeed;
document.getElementById('btn-backup')      .onclick = cmdBackup;
document.getElementById('btn-setup')       .onclick = cmdSetup;
document.getElementById('btn-health')      .onclick = cmdHealth;
document.getElementById('btn-logs')        .onclick = cmdLogs;
document.getElementById('btn-web')         .onclick = function(){ openUrl('http://localhost:8080'); };
document.getElementById('btn-apidocs')     .onclick = function(){ openUrl('http://localhost:8000/docs'); };
document.getElementById('btn-orthanc')     .onclick = function(){ openUrl('http://localhost:8043'); };
document.getElementById('btn-clean')       .onclick = showModal;
document.getElementById('btn-clear')       .onclick = clearLog;
document.getElementById('btn-modal-cancel').onclick = hideModal;
document.getElementById('btn-modal-ok')    .onclick = cmdClean;

// ── Clock ─────────────────────────────────────────────────────────
setInterval(function(){
  document.getElementById('sbtime').innerText = new Date().toLocaleTimeString();
}, 1000);

// ── Auto health check on load ─────────────────────────────────────
setTimeout(function(){
  try {
    var out = capture('curl -s --connect-timeout 2 http://localhost:8000/health');
    setStatus(out.trim() ? 'Ejecutando' : 'Detenido', !!out.trim());
  } catch(e) { setStatus('Detenido', false); }
}, 900);

</script>
</body>
</html>
